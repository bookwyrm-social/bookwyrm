{% extends 'settings/layout.html' %}
{% load humanize %}
{% load i18n %}

{% block title %}{% trans "Redis Status" %}{% endblock %}

{% block header %}{% trans "Redis Status" %}{% endblock %}

{% block panel %}

{% if info %}
<section class="block content">
    <h2>{% trans "Info" %}</h2>
    <div class="columns has-text-centered is-multiline">
        <div class="column is-4">
            <div class="notification">
                <p class="header">{% trans "Used memory" %}</p>
                <p class="title is-5">{{ info.used_memory_human }}</p>
            </div>
        </div>
        <div class="column is-4">
            <div class="notification">
                <p class="header">{% trans "Total system memory" %}</p>
                <p class="title is-5">{{ info.total_system_memory_human }}</p>
            </div>
        </div>
        <div class="column is-4">
            <div class="notification">
                <p class="header">{% trans "Keys" %}</p>
                <p class="title is-5">{{ info.db0.keys | intcomma }}</p>
            </div>
        </div>
    </div>
</section>

<section class="block content">
    <h2>{% trans "Outdated cache keys" %}</h2>
    <div class="box">
        <p>
        {% blocktrans trimmed %}
        This will scan for keys in the Django redis cache that use no prefix (the current prefix is <code>{{ prefix }}</code>), and identify Activity Streams for users with deleted accounts.
        {% endblocktrans %}
        </p>

        {% if outdated_identified is not None %}
            <p class="notification has-text-weight-bold">
            {% blocktrans trimmed with keys=outdated_identified|intcomma %}
                {{ keys }} identified
            {% endblocktrans %}
            </p>

            {% if outdated_identified > 0 %}
            <form name="erase-keys" method="POST" action="{% url 'settings-redis' %}">
                {% csrf_token %}
                <button type="submit" class="button is-danger">{% trans "Erase outdated keys" %}</button>
            </form>
            {% endif %}
        {% else %}
        <form name="scan-keys" method="POST" action="{% url 'settings-redis' %}">
            {% csrf_token %}
                <input type="hidden" name="dry_run" value="True">
                <button type="submit" class="button">
                    {% trans "Scan for outdated keys" %}
                </button>
        </form>
        {% endif %}
    </div>
</section>

<section class="block content">
    <h2>{% trans "Advanced" %}</h2>
    <details class="details-panel box">
        <summary>
            <span class="title is-5" role="headind" aria-level="3">
                {% trans "Clear Django Cache" %}
            </span>
            <span class="details-close icon icon-x" aria-hidden="true"></span>
        </summary>

        <p>
        {% blocktrans trimmed %}
        This is <strong>NOT recommended</strong> and should only be used if something has gone very wrong with your cache. All sessions will be cleared and users will be logged out of their accounts.
        {% endblocktrans %}
        </p>

        {% if cache_deleted %}
            <p class="notification has-text-weight-bold">
            {% blocktrans trimmed with keys=cache_deleted|intcomma %}
                {{ keys }} keys deleted
            {% endblocktrans %}
            </p>
        {% else %}
            <form name="erase-cache" method="POST" action="{% url 'settings-redis' %}">
                {% csrf_token %}
                <input type="hidden" name="erase_cache" value="True">
                <div class="control">
                    <button type="submit" class="button is-danger">{% trans "Erase cache" %}</button>
                </div>
            </form>
        {% endif %}
    </details>
</section>

{% else %}

<div class="notification is-danger is-flex is-align-items-start">
    <span class="icon icon-warning is-size-4 pr-3" aria-hidden="true"></span>
    <span>
        {% trans "Could not connect to Redis Activity" %}
    </span>
</div>

{% endif %}

{% if errors %}
<div class="block content">
    <h2>{% trans "Errors" %}</h2>
    {% for error in errors %}
    <pre>{{ error }}</pre>
{% endfor %}

</div>
{% endif %}

{% endblock %}
