{% extends 'email/html_layout.html' %}
{% load i18n %}

{% block content %}
<p style="margin-bottom: 1.5rem; color: #666;">{% blocktrans trimmed %}Here's what happened in your reading community on {{ date_str }}:{% endblocktrans %}</p>

{# ===== YOUR ACTIVITY SECTION ===== #}
{% if own_activities.reviews or own_activities.comments or own_activities.quotations or own_activities.shelf_changes %}
<h2 style="color: #3273dc; margin-top: 1.5rem; margin-bottom: 1rem; font-size: 1.1rem; border-bottom: 2px solid #3273dc; padding-bottom: 0.5rem;">{% trans "Your Activity" %}</h2>

{% if own_activities.reviews %}
<p style="font-weight: bold; color: #333; margin-bottom: 0.5rem;">{% trans "Reviews" %}</p>
{% for item in own_activities.reviews %}
<table style="width: 100%; margin-bottom: 1rem; border-collapse: collapse;" cellpadding="0" cellspacing="0">
<tr>
    {% if item.book_cover %}
    <td style="width: 60px; vertical-align: top; padding-right: 12px;">
        <a href="{{ base_url }}{{ item.activity.book.local_path }}">
            <img src="{{ item.book_cover }}" alt="{{ item.activity.book.title }}" width="60" style="border-radius: 4px; display: block;">
        </a>
    </td>
    {% endif %}
    <td style="vertical-align: top;">
        <a href="{{ base_url }}{{ item.activity.book.local_path }}" style="color: #3273dc; font-weight: bold; text-decoration: none; font-size: 1rem;">{{ item.activity.book.title }}</a>
        {% if item.activity.rating %}<span style="color: #f39c12; margin-left: 0.5rem;">{% for i in "12345" %}{% if forloop.counter <= item.activity.rating %}★{% else %}☆{% endif %}{% endfor %}</span>{% endif %}
        {% if item.activity.book.description %}
        <p style="color: #666; font-size: 0.9rem; margin: 0.3rem 0;">{{ item.activity.book.description|striptags }}</p>
        {% endif %}
        <a href="{{ base_url }}{{ item.activity.book.local_path }}" style="display: inline-block; margin-top: 0.5rem; padding: 0.4rem 0.8rem; background-color: #3273dc; color: white; text-decoration: none; border-radius: 4px; font-size: 0.85rem;">{% trans "Want to Read" %}</a>
    </td>
</tr>
</table>
{% endfor %}
{% endif %}

{% if own_activities.comments %}
<p style="font-weight: bold; color: #333; margin-bottom: 0.5rem; margin-top: 1rem;">{% trans "Comments" %}</p>
{% for item in own_activities.comments %}
<table style="width: 100%; margin-bottom: 1rem; border-collapse: collapse;" cellpadding="0" cellspacing="0">
<tr>
    {% if item.book_cover %}
    <td style="width: 60px; vertical-align: top; padding-right: 12px;">
        <a href="{{ base_url }}{{ item.activity.book.local_path }}">
            <img src="{{ item.book_cover }}" alt="{{ item.activity.book.title }}" width="60" style="border-radius: 4px; display: block;">
        </a>
    </td>
    {% endif %}
    <td style="vertical-align: top;">
        <span style="color: #666; font-size: 0.9rem;">{% trans "Comment on" %}</span>
        <a href="{{ base_url }}{{ item.activity.book.local_path }}" style="color: #3273dc; font-weight: bold; text-decoration: none;">{{ item.activity.book.title }}</a>
        {% if item.activity.book.description %}
        <p style="color: #666; font-size: 0.9rem; margin: 0.3rem 0;">{{ item.activity.book.description|striptags }}</p>
        {% endif %}
        <a href="{{ base_url }}{{ item.activity.book.local_path }}" style="display: inline-block; margin-top: 0.5rem; padding: 0.4rem 0.8rem; background-color: #3273dc; color: white; text-decoration: none; border-radius: 4px; font-size: 0.85rem;">{% trans "Want to Read" %}</a>
    </td>
</tr>
</table>
{% endfor %}
{% endif %}

{% if own_activities.quotations %}
<p style="font-weight: bold; color: #333; margin-bottom: 0.5rem; margin-top: 1rem;">{% trans "Highlights" %}</p>
{% for item in own_activities.quotations %}
<table style="width: 100%; margin-bottom: 1rem; border-collapse: collapse;" cellpadding="0" cellspacing="0">
<tr>
    {% if item.book_cover %}
    <td style="width: 60px; vertical-align: top; padding-right: 12px;">
        <a href="{{ base_url }}{{ item.activity.book.local_path }}">
            <img src="{{ item.book_cover }}" alt="{{ item.activity.book.title }}" width="60" style="border-radius: 4px; display: block;">
        </a>
    </td>
    {% endif %}
    <td style="vertical-align: top;">
        <span style="color: #666; font-size: 0.9rem;">{% trans "From" %}</span>
        <a href="{{ base_url }}{{ item.activity.book.local_path }}" style="color: #3273dc; font-weight: bold; text-decoration: none;">{{ item.activity.book.title }}</a>
        {% if item.activity.quote %}
        <blockquote style="margin: 0.5rem 0; padding: 0.5rem 1rem; border-left: 3px solid #3273dc; background-color: #f5f5f5; font-style: italic; color: #333;">
            {{ item.activity.quote|striptags|truncatechars:500 }}
        </blockquote>
        {% endif %}
        <a href="{{ base_url }}{{ item.activity.book.local_path }}" style="display: inline-block; margin-top: 0.5rem; padding: 0.4rem 0.8rem; background-color: #3273dc; color: white; text-decoration: none; border-radius: 4px; font-size: 0.85rem;">{% trans "Want to Read" %}</a>
    </td>
</tr>
</table>
{% endfor %}
{% endif %}

{% if own_activities.shelf_changes %}
<p style="font-weight: bold; color: #333; margin-bottom: 0.5rem; margin-top: 1rem;">{% trans "Shelf Updates" %}</p>
{% for item in own_activities.shelf_changes %}
<table style="width: 100%; margin-bottom: 1rem; border-collapse: collapse;" cellpadding="0" cellspacing="0">
<tr>
    {% if item.book_cover %}
    <td style="width: 60px; vertical-align: top; padding-right: 12px;">
        <a href="{{ base_url }}{{ item.activity.book.local_path }}">
            <img src="{{ item.book_cover }}" alt="{{ item.activity.book.title }}" width="60" style="border-radius: 4px; display: block;">
        </a>
    </td>
    {% endif %}
    <td style="vertical-align: top;">
        <a href="{{ base_url }}{{ item.activity.book.local_path }}" style="color: #3273dc; font-weight: bold; text-decoration: none;">{{ item.activity.book.title }}</a>
        <span style="color: #666;"> → {{ item.activity.shelf.name }}</span>
        {% if item.activity.book.description %}
        <p style="color: #666; font-size: 0.9rem; margin: 0.3rem 0;">{{ item.activity.book.description|striptags }}</p>
        {% endif %}
    </td>
</tr>
</table>
{% endfor %}
{% endif %}
{% endif %}

{# ===== FROM PEOPLE YOU FOLLOW SECTION ===== #}
{% if followed_activities.reviews or followed_activities.comments or followed_activities.quotations or followed_activities.shelf_changes %}
<h2 style="color: #3273dc; margin-top: 2rem; margin-bottom: 1rem; font-size: 1.1rem; border-bottom: 2px solid #3273dc; padding-bottom: 0.5rem;">{% trans "From People You Follow" %}</h2>

{% if followed_activities.reviews %}
<p style="font-weight: bold; color: #333; margin-bottom: 0.5rem;">{% trans "Reviews" %}</p>
{% for group in followed_activities.reviews %}
{# User header with avatar #}
<table style="width: 100%; margin-bottom: 0.5rem; border-collapse: collapse;" cellpadding="0" cellspacing="0">
<tr>
    <td style="width: 32px; vertical-align: middle; padding-right: 8px;">
        {% if group.user_avatar %}
        <img src="{{ group.user_avatar }}" alt="{{ group.user.display_name }}" width="32" height="32" style="border-radius: 50%; display: block;">
        {% else %}
        <div style="width: 32px; height: 32px; border-radius: 50%; background-color: #3273dc; color: white; text-align: center; line-height: 32px; font-weight: bold; font-size: 14px;">{{ group.user.display_name|first|upper }}</div>
        {% endif %}
    </td>
    <td style="vertical-align: middle;">
        <strong style="color: #333;">{{ group.user.display_name }}</strong> <span style="color: #666;">{% trans "reviewed" %}</span>
    </td>
</tr>
</table>
{# Books from this user #}
{% for item in group.items %}
<table style="width: 100%; margin-bottom: 1rem; margin-left: 40px; border-collapse: collapse;" cellpadding="0" cellspacing="0">
<tr>
    {% if item.book_cover %}
    <td style="width: 50px; vertical-align: top; padding-right: 10px;">
        <a href="{{ base_url }}{{ item.activity.book.local_path }}">
            <img src="{{ item.book_cover }}" alt="{{ item.activity.book.title }}" width="50" style="border-radius: 4px; display: block;">
        </a>
    </td>
    {% endif %}
    <td style="vertical-align: top;">
        <a href="{{ base_url }}{{ item.activity.book.local_path }}" style="color: #3273dc; font-weight: bold; text-decoration: none;">{{ item.activity.book.title }}</a>
        {% if item.activity.rating %}<span style="color: #f39c12; margin-left: 0.3rem; font-size: 0.9rem;">{% for i in "12345" %}{% if forloop.counter <= item.activity.rating %}★{% else %}☆{% endif %}{% endfor %}</span>{% endif %}
        {% if item.activity.book.description %}
        <p style="color: #666; font-size: 0.85rem; margin: 0.2rem 0;">{{ item.activity.book.description|striptags }}</p>
        {% endif %}
        <a href="{{ base_url }}{{ item.activity.book.local_path }}" style="display: inline-block; margin-top: 0.3rem; padding: 0.3rem 0.6rem; background-color: #3273dc; color: white; text-decoration: none; border-radius: 4px; font-size: 0.8rem;">{% trans "Want to Read" %}</a>
    </td>
</tr>
</table>
{% endfor %}
{% endfor %}
{% endif %}

{% if followed_activities.comments %}
<p style="font-weight: bold; color: #333; margin-bottom: 0.5rem; margin-top: 1.5rem;">{% trans "Comments" %}</p>
{% for group in followed_activities.comments %}
<table style="width: 100%; margin-bottom: 0.5rem; border-collapse: collapse;" cellpadding="0" cellspacing="0">
<tr>
    <td style="width: 32px; vertical-align: middle; padding-right: 8px;">
        {% if group.user_avatar %}
        <img src="{{ group.user_avatar }}" alt="{{ group.user.display_name }}" width="32" height="32" style="border-radius: 50%; display: block;">
        {% else %}
        <div style="width: 32px; height: 32px; border-radius: 50%; background-color: #3273dc; color: white; text-align: center; line-height: 32px; font-weight: bold; font-size: 14px;">{{ group.user.display_name|first|upper }}</div>
        {% endif %}
    </td>
    <td style="vertical-align: middle;">
        <strong style="color: #333;">{{ group.user.display_name }}</strong> <span style="color: #666;">{% trans "commented on" %}</span>
    </td>
</tr>
</table>
{% for item in group.items %}
<table style="width: 100%; margin-bottom: 1rem; margin-left: 40px; border-collapse: collapse;" cellpadding="0" cellspacing="0">
<tr>
    {% if item.book_cover %}
    <td style="width: 50px; vertical-align: top; padding-right: 10px;">
        <a href="{{ base_url }}{{ item.activity.book.local_path }}">
            <img src="{{ item.book_cover }}" alt="{{ item.activity.book.title }}" width="50" style="border-radius: 4px; display: block;">
        </a>
    </td>
    {% endif %}
    <td style="vertical-align: top;">
        <a href="{{ base_url }}{{ item.activity.book.local_path }}" style="color: #3273dc; font-weight: bold; text-decoration: none;">{{ item.activity.book.title }}</a>
        {% if item.activity.book.description %}
        <p style="color: #666; font-size: 0.85rem; margin: 0.2rem 0;">{{ item.activity.book.description|striptags }}</p>
        {% endif %}
        <a href="{{ base_url }}{{ item.activity.book.local_path }}" style="display: inline-block; margin-top: 0.3rem; padding: 0.3rem 0.6rem; background-color: #3273dc; color: white; text-decoration: none; border-radius: 4px; font-size: 0.8rem;">{% trans "Want to Read" %}</a>
    </td>
</tr>
</table>
{% endfor %}
{% endfor %}
{% endif %}

{% if followed_activities.quotations %}
<p style="font-weight: bold; color: #333; margin-bottom: 0.5rem; margin-top: 1.5rem;">{% trans "Highlights" %}</p>
{% for group in followed_activities.quotations %}
<table style="width: 100%; margin-bottom: 0.5rem; border-collapse: collapse;" cellpadding="0" cellspacing="0">
<tr>
    <td style="width: 32px; vertical-align: middle; padding-right: 8px;">
        {% if group.user_avatar %}
        <img src="{{ group.user_avatar }}" alt="{{ group.user.display_name }}" width="32" height="32" style="border-radius: 50%; display: block;">
        {% else %}
        <div style="width: 32px; height: 32px; border-radius: 50%; background-color: #3273dc; color: white; text-align: center; line-height: 32px; font-weight: bold; font-size: 14px;">{{ group.user.display_name|first|upper }}</div>
        {% endif %}
    </td>
    <td style="vertical-align: middle;">
        <strong style="color: #333;">{{ group.user.display_name }}</strong> <span style="color: #666;">{% trans "highlighted" %}</span>
    </td>
</tr>
</table>
{% for item in group.items %}
<table style="width: 100%; margin-bottom: 1rem; margin-left: 40px; border-collapse: collapse;" cellpadding="0" cellspacing="0">
<tr>
    {% if item.book_cover %}
    <td style="width: 50px; vertical-align: top; padding-right: 10px;">
        <a href="{{ base_url }}{{ item.activity.book.local_path }}">
            <img src="{{ item.book_cover }}" alt="{{ item.activity.book.title }}" width="50" style="border-radius: 4px; display: block;">
        </a>
    </td>
    {% endif %}
    <td style="vertical-align: top;">
        <a href="{{ base_url }}{{ item.activity.book.local_path }}" style="color: #3273dc; font-weight: bold; text-decoration: none;">{{ item.activity.book.title }}</a>
        {% if item.activity.quote %}
        <blockquote style="margin: 0.5rem 0; padding: 0.5rem 1rem; border-left: 3px solid #3273dc; background-color: #f5f5f5; font-style: italic; color: #333; font-size: 0.9rem;">
            {{ item.activity.quote|striptags|truncatechars:500 }}
        </blockquote>
        {% endif %}
        <a href="{{ base_url }}{{ item.activity.book.local_path }}" style="display: inline-block; margin-top: 0.3rem; padding: 0.3rem 0.6rem; background-color: #3273dc; color: white; text-decoration: none; border-radius: 4px; font-size: 0.8rem;">{% trans "Want to Read" %}</a>
    </td>
</tr>
</table>
{% endfor %}
{% endfor %}
{% endif %}

{% if followed_activities.shelf_changes %}
<p style="font-weight: bold; color: #333; margin-bottom: 0.5rem; margin-top: 1.5rem;">{% trans "Shelf Updates" %}</p>
{% for group in followed_activities.shelf_changes %}
<table style="width: 100%; margin-bottom: 0.5rem; border-collapse: collapse;" cellpadding="0" cellspacing="0">
<tr>
    <td style="width: 32px; vertical-align: middle; padding-right: 8px;">
        {% if group.user_avatar %}
        <img src="{{ group.user_avatar }}" alt="{{ group.user.display_name }}" width="32" height="32" style="border-radius: 50%; display: block;">
        {% else %}
        <div style="width: 32px; height: 32px; border-radius: 50%; background-color: #3273dc; color: white; text-align: center; line-height: 32px; font-weight: bold; font-size: 14px;">{{ group.user.display_name|first|upper }}</div>
        {% endif %}
    </td>
    <td style="vertical-align: middle;">
        <strong style="color: #333;">{{ group.user.display_name }}</strong> <span style="color: #666;">{% trans "shelved" %}</span>
    </td>
</tr>
</table>
{% for item in group.items %}
<table style="width: 100%; margin-bottom: 1rem; margin-left: 40px; border-collapse: collapse;" cellpadding="0" cellspacing="0">
<tr>
    {% if item.book_cover %}
    <td style="width: 50px; vertical-align: top; padding-right: 10px;">
        <a href="{{ base_url }}{{ item.activity.book.local_path }}">
            <img src="{{ item.book_cover }}" alt="{{ item.activity.book.title }}" width="50" style="border-radius: 4px; display: block;">
        </a>
    </td>
    {% endif %}
    <td style="vertical-align: top;">
        <a href="{{ base_url }}{{ item.activity.book.local_path }}" style="color: #3273dc; font-weight: bold; text-decoration: none;">{{ item.activity.book.title }}</a>
        <span style="color: #666; font-size: 0.9rem;"> → {{ item.activity.shelf.name }}</span>
        {% if item.activity.book.description %}
        <p style="color: #666; font-size: 0.85rem; margin: 0.2rem 0;">{{ item.activity.book.description|striptags }}</p>
        {% endif %}
        <a href="{{ base_url }}{{ item.activity.book.local_path }}" style="display: inline-block; margin-top: 0.3rem; padding: 0.3rem 0.6rem; background-color: #3273dc; color: white; text-decoration: none; border-radius: 4px; font-size: 0.8rem;">{% trans "Want to Read" %}</a>
    </td>
</tr>
</table>
{% endfor %}
{% endfor %}
{% endif %}
{% endif %}

{# ===== CURRENTLY READING SECTION ===== #}
{% if currently_reading %}
<h2 style="color: #3273dc; margin-top: 2rem; margin-bottom: 1rem; font-size: 1.1rem; border-bottom: 2px solid #3273dc; padding-bottom: 0.5rem;">{% trans "You're Currently Reading" %}</h2>

{% for item in currently_reading %}
<table style="width: 100%; margin-bottom: 1rem; border-collapse: collapse;" cellpadding="0" cellspacing="0">
<tr>
    {% if item.book_cover %}
    <td style="width: 60px; vertical-align: top; padding-right: 12px;">
        <a href="{{ base_url }}{{ item.readthrough.book.local_path }}">
            <img src="{{ item.book_cover }}" alt="{{ item.readthrough.book.title }}" width="60" style="border-radius: 4px; display: block;">
        </a>
    </td>
    {% endif %}
    <td style="vertical-align: top;">
        <a href="{{ base_url }}{{ item.readthrough.book.local_path }}" style="color: #3273dc; font-weight: bold; text-decoration: none; font-size: 1rem;">{{ item.readthrough.book.title }}</a>
        {% if item.readthrough.progress %}
        <p style="color: #666; font-size: 0.9rem; margin: 0.3rem 0;">
            {% blocktrans with progress=item.readthrough.progress %}{{ progress }}% complete{% endblocktrans %}
        </p>
        {% elif item.readthrough.start_date %}
        <p style="color: #666; font-size: 0.9rem; margin: 0.3rem 0;">
            {% blocktrans with date=item.readthrough.start_date|date:"M d" %}Started {{ date }}{% endblocktrans %}
        </p>
        {% endif %}
        <a href="{{ base_url }}{{ item.readthrough.book.local_path }}" style="display: inline-block; margin-top: 0.5rem; padding: 0.4rem 0.8rem; background-color: #48c774; color: white; text-decoration: none; border-radius: 4px; font-size: 0.85rem;">{% trans "Update Progress" %}</a>
    </td>
</tr>
</table>
{% endfor %}
{% endif %}

<p style="margin-top: 2rem; text-align: center;">
    <a href="{{ base_url }}" style="display: inline-block; padding: 0.6rem 1.5rem; background-color: #3273dc; color: white; text-decoration: none; border-radius: 4px; font-size: 1rem;">{% trans "Visit your feed" %}</a>
</p>
{% endblock %}
