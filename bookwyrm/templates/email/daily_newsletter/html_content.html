{% extends 'email/html_layout.html' %}
{% load i18n %}

{% block content %}
<p style="margin-bottom: 24px; color: #3a3a3a; font-size: 16px; line-height: 1.6;">{% blocktrans trimmed %}Here's what happened in your reading community on {{ date_str }}:{% endblocktrans %}</p>

{# ===== YOUR ACTIVITY SECTION ===== #}
{% if own_activities.reviews or own_activities.comments or own_activities.quotations or own_activities.shelf_changes %}
<h2 style="color: #000000; margin-top: 24px; margin-bottom: 16px; font-size: 18px; border-bottom: 1px solid #e0e0e0; padding-bottom: 8px; font-weight: normal; letter-spacing: 0.02em;">{% trans "Your Activity" %}</h2>

{% if own_activities.reviews %}
<p style="font-weight: normal; color: #000000; margin-bottom: 8px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.05em;">{% trans "Reviews" %}</p>
{% for item in own_activities.reviews %}
<table style="width: 100%; margin-bottom: 20px; border-collapse: collapse;" cellpadding="0" cellspacing="0">
<tr>
    {% if item.book_cover %}
    <td style="width: 80px; vertical-align: top; padding-right: 20px;">
        <a href="{{ base_url }}{{ item.activity.book.local_path }}">
            <img src="{{ item.book_cover }}" alt="{{ item.activity.book.title }}" width="80" style="display: block; max-width: 80px; border: 1px solid #e0e0e0; box-shadow: 0 1px 3px rgba(0,0,0,0.12);">
        </a>
    </td>
    {% endif %}
    <td style="vertical-align: top;">
        <a href="{{ base_url }}{{ item.activity.book.local_path }}" style="color: #9a0000; font-weight: normal; text-decoration: none; font-size: 16px;">{{ item.activity.book.title }}</a>
        {% if item.activity.rating %}<span style="color: #9a0000; margin-left: 8px; font-size: 14px;">{% for i in "12345" %}{% if forloop.counter <= item.activity.rating %}★{% else %}☆{% endif %}{% endfor %}</span>{% endif %}
        {% if item.activity.content %}
        <p style="color: #3a3a3a; font-size: 15px; margin: 6px 0; line-height: 1.6;">{{ item.activity.content|striptags|truncatechars:150 }}</p>
        {% endif %}
        <div style="margin-top: 10px;">
            <a href="{{ base_url }}{{ item.activity.local_path }}" style="display: inline-block; padding: 12px 20px; background-color: #9a0000; color: white; text-decoration: none; font-size: 14px; min-width: 44px; text-align: center;">{% trans "Read Review" %}</a>
            <a href="{{ base_url }}{{ item.activity.local_path }}#comment" style="display: inline-block; margin-left: 8px; padding: 12px 20px; background-color: #f5f5f5; color: #000000; text-decoration: none; font-size: 14px; border: 1px solid #d0d0d0; min-width: 44px; text-align: center;">{% trans "Reply" %}</a>
        </div>
    </td>
</tr>
</table>
{% endfor %}
{% endif %}

{% if own_activities.comments %}
<p style="font-weight: normal; color: #000000; margin-bottom: 8px; margin-top: 20px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.05em;">{% trans "Comments" %}</p>
{% for item in own_activities.comments %}
<table style="width: 100%; margin-bottom: 20px; border-collapse: collapse;" cellpadding="0" cellspacing="0">
<tr>
    {% if item.book_cover %}
    <td style="width: 80px; vertical-align: top; padding-right: 20px;">
        <a href="{{ base_url }}{{ item.activity.book.local_path }}">
            <img src="{{ item.book_cover }}" alt="{{ item.activity.book.title }}" width="80" style="display: block; max-width: 80px; border: 1px solid #e0e0e0; box-shadow: 0 1px 3px rgba(0,0,0,0.12);">
        </a>
    </td>
    {% endif %}
    <td style="vertical-align: top;">
        <span style="color: #3a3a3a; font-size: 14px;">{% trans "Comment on" %}</span>
        <a href="{{ base_url }}{{ item.activity.book.local_path }}" style="color: #9a0000; text-decoration: none;">{{ item.activity.book.title }}</a>
        {% if item.activity.content %}
        <p style="color: #3a3a3a; font-size: 15px; margin: 6px 0; line-height: 1.6;">{{ item.activity.content|striptags|truncatechars:150 }}</p>
        {% endif %}
        <div style="margin-top: 10px;">
            <a href="{{ base_url }}{{ item.activity.local_path }}" style="display: inline-block; padding: 12px 20px; background-color: #9a0000; color: white; text-decoration: none; font-size: 14px; min-width: 44px; text-align: center;">{% trans "View Comment" %}</a>
            <a href="{{ base_url }}{{ item.activity.local_path }}#comment" style="display: inline-block; margin-left: 8px; padding: 12px 20px; background-color: #f5f5f5; color: #000000; text-decoration: none; font-size: 14px; border: 1px solid #d0d0d0; min-width: 44px; text-align: center;">{% trans "Reply" %}</a>
        </div>
    </td>
</tr>
</table>
{% endfor %}
{% endif %}

{% if own_activities.quotations %}
<p style="font-weight: normal; color: #000000; margin-bottom: 8px; margin-top: 20px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.05em;">{% trans "Highlights" %}</p>
{% for item in own_activities.quotations %}
<table style="width: 100%; margin-bottom: 20px; border-collapse: collapse;" cellpadding="0" cellspacing="0">
<tr>
    {% if item.book_cover %}
    <td style="width: 80px; vertical-align: top; padding-right: 20px;">
        <a href="{{ base_url }}{{ item.activity.book.local_path }}">
            <img src="{{ item.book_cover }}" alt="{{ item.activity.book.title }}" width="80" style="display: block; max-width: 80px; border: 1px solid #e0e0e0; box-shadow: 0 1px 3px rgba(0,0,0,0.12);">
        </a>
    </td>
    {% endif %}
    <td style="vertical-align: top;">
        <span style="color: #3a3a3a; font-size: 14px;">{% trans "From" %}</span>
        <a href="{{ base_url }}{{ item.activity.book.local_path }}" style="color: #9a0000; text-decoration: none;">{{ item.activity.book.title }}</a>
        {% if item.activity.quote %}
        <blockquote style="margin: 10px 0; padding: 12px 20px; border-left: 2px solid #9a0000; background-color: #fafafa; font-style: italic; color: #000000; line-height: 1.7;">
            {{ item.activity.quote|striptags|truncatechars:300 }}
        </blockquote>
        {% endif %}
        <div style="margin-top: 10px;">
            <a href="{{ base_url }}{{ item.activity.local_path }}" style="display: inline-block; padding: 12px 20px; background-color: #9a0000; color: white; text-decoration: none; font-size: 14px; min-width: 44px; text-align: center;">{% trans "See Quote" %}</a>
            <a href="{{ base_url }}{{ item.activity.local_path }}#comment" style="display: inline-block; margin-left: 8px; padding: 12px 20px; background-color: #f5f5f5; color: #000000; text-decoration: none; font-size: 14px; border: 1px solid #d0d0d0; min-width: 44px; text-align: center;">{% trans "Reply" %}</a>
        </div>
    </td>
</tr>
</table>
{% endfor %}
{% endif %}

{% if own_activities.shelf_changes %}
<p style="font-weight: normal; color: #000000; margin-bottom: 8px; margin-top: 20px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.05em;">{% trans "Shelf Updates" %}</p>
{% for item in own_activities.shelf_changes %}
<table style="width: 100%; margin-bottom: 20px; border-collapse: collapse;" cellpadding="0" cellspacing="0">
<tr>
    {% if item.book_cover %}
    <td style="width: 80px; vertical-align: top; padding-right: 20px;">
        <a href="{{ base_url }}{{ item.activity.book.local_path }}">
            <img src="{{ item.book_cover }}" alt="{{ item.activity.book.title }}" width="80" style="display: block; max-width: 80px; border: 1px solid #e0e0e0; box-shadow: 0 1px 3px rgba(0,0,0,0.12);">
        </a>
    </td>
    {% endif %}
    <td style="vertical-align: top;">
        <a href="{{ base_url }}{{ item.activity.book.local_path }}" style="color: #9a0000; text-decoration: none;">{{ item.activity.book.title }}</a>
        <span style="color: #3a3a3a;"> → {{ item.activity.shelf.name }}</span>
        {% if item.activity.book.description %}
        <p style="color: #3a3a3a; font-size: 15px; margin: 6px 0; line-height: 1.6;">{{ item.activity.book.description|striptags|truncatechars:150 }}</p>
        {% endif %}
        <div style="margin-top: 10px;">
            <a href="{{ base_url }}{{ item.activity.book.local_path }}" style="display: inline-block; padding: 12px 20px; background-color: #9a0000; color: white; text-decoration: none; font-size: 14px; min-width: 44px; text-align: center;">{% trans "View Book" %}</a>
        </div>
    </td>
</tr>
</table>
{% endfor %}
{% endif %}
{% endif %}

{# ===== FROM PEOPLE YOU FOLLOW SECTION ===== #}
{% if followed_activities.reviews or followed_activities.comments or followed_activities.quotations or followed_activities.shelf_changes %}
<h2 style="color: #000000; margin-top: 32px; margin-bottom: 16px; font-size: 18px; border-bottom: 1px solid #e0e0e0; padding-bottom: 8px; font-weight: normal; letter-spacing: 0.02em;">{% trans "From People You Follow" %}</h2>

{% if followed_activities.reviews %}
<p style="font-weight: normal; color: #000000; margin-bottom: 8px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.05em;">{% trans "Reviews" %}</p>
{% for group in followed_activities.reviews %}
{# User header with avatar #}
<table style="width: 100%; margin-bottom: 8px; border-collapse: collapse;" cellpadding="0" cellspacing="0">
<tr>
    <td style="width: 36px; vertical-align: middle; padding-right: 10px;">
        {% if group.user_avatar %}
        <img src="{{ group.user_avatar }}" alt="{{ group.user.display_name }}" width="36" height="36" style="border-radius: 50%; display: block;">
        {% else %}
        <div style="width: 36px; height: 36px; border-radius: 50%; background-color: #9a0000; color: white; text-align: center; line-height: 36px; font-weight: normal; font-size: 14px;">{{ group.user.display_name|first|upper }}</div>
        {% endif %}
    </td>
    <td style="vertical-align: middle;">
        <strong style="color: #000000; font-weight: normal;">{{ group.user.display_name }}</strong> <span style="color: #3a3a3a;">{% trans "reviewed" %}</span>
    </td>
</tr>
</table>
{# Books from this user - use nested table for Outlook compatibility #}
{% for item in group.items %}
<table style="width: 100%; margin-bottom: 16px; border-collapse: collapse;" cellpadding="0" cellspacing="0">
<tr>
    <td style="width: 46px;"></td>
    <td>
        <table style="width: 100%; border-collapse: collapse;" cellpadding="0" cellspacing="0">
        <tr>
            {% if item.book_cover %}
            <td style="width: 65px; vertical-align: top; padding-right: 16px;">
                <a href="{{ base_url }}{{ item.activity.book.local_path }}">
                    <img src="{{ item.book_cover }}" alt="{{ item.activity.book.title }}" width="65" style="display: block; max-width: 65px; border: 1px solid #e0e0e0; box-shadow: 0 1px 3px rgba(0,0,0,0.12);">
                </a>
            </td>
            {% endif %}
            <td style="vertical-align: top;">
                <a href="{{ base_url }}{{ item.activity.book.local_path }}" style="color: #9a0000; text-decoration: none;">{{ item.activity.book.title }}</a>
                {% if item.activity.rating %}<span style="color: #9a0000; margin-left: 5px; font-size: 14px;">{% for i in "12345" %}{% if forloop.counter <= item.activity.rating %}★{% else %}☆{% endif %}{% endfor %}</span>{% endif %}
                {% if item.activity.content %}
                <p style="color: #3a3a3a; font-size: 14px; margin: 5px 0; line-height: 1.6;">{{ item.activity.content|striptags|truncatechars:120 }}</p>
                {% endif %}
                <div style="margin-top: 8px;">
                    <a href="{{ base_url }}{{ item.activity.local_path }}" style="display: inline-block; padding: 10px 16px; background-color: #9a0000; color: white; text-decoration: none; font-size: 13px; min-width: 44px; text-align: center;">{% trans "Read Review" %}</a>
                    <a href="{{ base_url }}{{ item.activity.local_path }}#comment" style="display: inline-block; margin-left: 6px; padding: 10px 16px; background-color: #f5f5f5; color: #000000; text-decoration: none; font-size: 13px; border: 1px solid #d0d0d0; min-width: 44px; text-align: center;">{% trans "Reply" %}</a>
                </div>
            </td>
        </tr>
        </table>
    </td>
</tr>
</table>
{% endfor %}
{% endfor %}
{% endif %}

{% if followed_activities.comments %}
<p style="font-weight: normal; color: #000000; margin-bottom: 8px; margin-top: 24px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.05em;">{% trans "Comments" %}</p>
{% for group in followed_activities.comments %}
<table style="width: 100%; margin-bottom: 8px; border-collapse: collapse;" cellpadding="0" cellspacing="0">
<tr>
    <td style="width: 36px; vertical-align: middle; padding-right: 10px;">
        {% if group.user_avatar %}
        <img src="{{ group.user_avatar }}" alt="{{ group.user.display_name }}" width="36" height="36" style="border-radius: 50%; display: block;">
        {% else %}
        <div style="width: 36px; height: 36px; border-radius: 50%; background-color: #9a0000; color: white; text-align: center; line-height: 36px; font-weight: normal; font-size: 14px;">{{ group.user.display_name|first|upper }}</div>
        {% endif %}
    </td>
    <td style="vertical-align: middle;">
        <strong style="color: #000000; font-weight: normal;">{{ group.user.display_name }}</strong> <span style="color: #3a3a3a;">{% trans "commented on" %}</span>
    </td>
</tr>
</table>
{% for item in group.items %}
<table style="width: 100%; margin-bottom: 16px; border-collapse: collapse;" cellpadding="0" cellspacing="0">
<tr>
    <td style="width: 46px;"></td>
    <td>
        <table style="width: 100%; border-collapse: collapse;" cellpadding="0" cellspacing="0">
        <tr>
            {% if item.book_cover %}
            <td style="width: 65px; vertical-align: top; padding-right: 16px;">
                <a href="{{ base_url }}{{ item.activity.book.local_path }}">
                    <img src="{{ item.book_cover }}" alt="{{ item.activity.book.title }}" width="65" style="display: block; max-width: 65px; border: 1px solid #e0e0e0; box-shadow: 0 1px 3px rgba(0,0,0,0.12);">
                </a>
            </td>
            {% endif %}
            <td style="vertical-align: top;">
                <a href="{{ base_url }}{{ item.activity.book.local_path }}" style="color: #9a0000; text-decoration: none;">{{ item.activity.book.title }}</a>
                {% if item.activity.content %}
                <p style="color: #3a3a3a; font-size: 14px; margin: 5px 0; line-height: 1.6;">{{ item.activity.content|striptags|truncatechars:120 }}</p>
                {% endif %}
                <div style="margin-top: 8px;">
                    <a href="{{ base_url }}{{ item.activity.local_path }}" style="display: inline-block; padding: 10px 16px; background-color: #9a0000; color: white; text-decoration: none; font-size: 13px; min-width: 44px; text-align: center;">{% trans "View Comment" %}</a>
                    <a href="{{ base_url }}{{ item.activity.local_path }}#comment" style="display: inline-block; margin-left: 6px; padding: 10px 16px; background-color: #f5f5f5; color: #000000; text-decoration: none; font-size: 13px; border: 1px solid #d0d0d0; min-width: 44px; text-align: center;">{% trans "Reply" %}</a>
                </div>
            </td>
        </tr>
        </table>
    </td>
</tr>
</table>
{% endfor %}
{% endfor %}
{% endif %}

{% if followed_activities.quotations %}
<p style="font-weight: normal; color: #000000; margin-bottom: 8px; margin-top: 24px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.05em;">{% trans "Highlights" %}</p>
{% for group in followed_activities.quotations %}
<table style="width: 100%; margin-bottom: 8px; border-collapse: collapse;" cellpadding="0" cellspacing="0">
<tr>
    <td style="width: 36px; vertical-align: middle; padding-right: 10px;">
        {% if group.user_avatar %}
        <img src="{{ group.user_avatar }}" alt="{{ group.user.display_name }}" width="36" height="36" style="border-radius: 50%; display: block;">
        {% else %}
        <div style="width: 36px; height: 36px; border-radius: 50%; background-color: #9a0000; color: white; text-align: center; line-height: 36px; font-weight: normal; font-size: 14px;">{{ group.user.display_name|first|upper }}</div>
        {% endif %}
    </td>
    <td style="vertical-align: middle;">
        <strong style="color: #000000; font-weight: normal;">{{ group.user.display_name }}</strong> <span style="color: #3a3a3a;">{% trans "highlighted" %}</span>
    </td>
</tr>
</table>
{% for item in group.items %}
<table style="width: 100%; margin-bottom: 16px; border-collapse: collapse;" cellpadding="0" cellspacing="0">
<tr>
    <td style="width: 46px;"></td>
    <td>
        <table style="width: 100%; border-collapse: collapse;" cellpadding="0" cellspacing="0">
        <tr>
            {% if item.book_cover %}
            <td style="width: 65px; vertical-align: top; padding-right: 16px;">
                <a href="{{ base_url }}{{ item.activity.book.local_path }}">
                    <img src="{{ item.book_cover }}" alt="{{ item.activity.book.title }}" width="65" style="display: block; max-width: 65px; border: 1px solid #e0e0e0; box-shadow: 0 1px 3px rgba(0,0,0,0.12);">
                </a>
            </td>
            {% endif %}
            <td style="vertical-align: top;">
                <a href="{{ base_url }}{{ item.activity.book.local_path }}" style="color: #9a0000; text-decoration: none;">{{ item.activity.book.title }}</a>
                {% if item.activity.quote %}
                <blockquote style="margin: 8px 0; padding: 10px 20px; border-left: 2px solid #9a0000; background-color: #fafafa; font-style: italic; color: #000000; font-size: 15px; line-height: 1.7;">
                    {{ item.activity.quote|striptags|truncatechars:250 }}
                </blockquote>
                {% endif %}
                <div style="margin-top: 8px;">
                    <a href="{{ base_url }}{{ item.activity.local_path }}" style="display: inline-block; padding: 10px 16px; background-color: #9a0000; color: white; text-decoration: none; font-size: 13px; min-width: 44px; text-align: center;">{% trans "See Quote" %}</a>
                    <a href="{{ base_url }}{{ item.activity.local_path }}#comment" style="display: inline-block; margin-left: 6px; padding: 10px 16px; background-color: #f5f5f5; color: #000000; text-decoration: none; font-size: 13px; border: 1px solid #d0d0d0; min-width: 44px; text-align: center;">{% trans "Reply" %}</a>
                </div>
            </td>
        </tr>
        </table>
    </td>
</tr>
</table>
{% endfor %}
{% endfor %}
{% endif %}

{% if followed_activities.shelf_changes %}
<p style="font-weight: normal; color: #000000; margin-bottom: 8px; margin-top: 24px; font-size: 14px; text-transform: uppercase; letter-spacing: 0.05em;">{% trans "Shelf Updates" %}</p>
{% for group in followed_activities.shelf_changes %}
<table style="width: 100%; margin-bottom: 8px; border-collapse: collapse;" cellpadding="0" cellspacing="0">
<tr>
    <td style="width: 36px; vertical-align: middle; padding-right: 10px;">
        {% if group.user_avatar %}
        <img src="{{ group.user_avatar }}" alt="{{ group.user.display_name }}" width="36" height="36" style="border-radius: 50%; display: block;">
        {% else %}
        <div style="width: 36px; height: 36px; border-radius: 50%; background-color: #9a0000; color: white; text-align: center; line-height: 36px; font-weight: normal; font-size: 14px;">{{ group.user.display_name|first|upper }}</div>
        {% endif %}
    </td>
    <td style="vertical-align: middle;">
        <strong style="color: #000000; font-weight: normal;">{{ group.user.display_name }}</strong> <span style="color: #3a3a3a;">{% trans "shelved" %}</span>
    </td>
</tr>
</table>
{% for item in group.items %}
<table style="width: 100%; margin-bottom: 16px; border-collapse: collapse;" cellpadding="0" cellspacing="0">
<tr>
    <td style="width: 46px;"></td>
    <td>
        <table style="width: 100%; border-collapse: collapse;" cellpadding="0" cellspacing="0">
        <tr>
            {% if item.book_cover %}
            <td style="width: 65px; vertical-align: top; padding-right: 16px;">
                <a href="{{ base_url }}{{ item.activity.book.local_path }}">
                    <img src="{{ item.book_cover }}" alt="{{ item.activity.book.title }}" width="65" style="display: block; max-width: 65px; border: 1px solid #e0e0e0; box-shadow: 0 1px 3px rgba(0,0,0,0.12);">
                </a>
            </td>
            {% endif %}
            <td style="vertical-align: top;">
                <a href="{{ base_url }}{{ item.activity.book.local_path }}" style="color: #9a0000; text-decoration: none;">{{ item.activity.book.title }}</a>
                <span style="color: #3a3a3a; font-size: 14px;"> → {{ item.activity.shelf.name }}</span>
                {% if item.activity.book.description %}
                <p style="color: #3a3a3a; font-size: 14px; margin: 5px 0; line-height: 1.6;">{{ item.activity.book.description|striptags|truncatechars:120 }}</p>
                {% endif %}
                <div style="margin-top: 8px;">
                    <a href="{{ base_url }}{{ item.activity.book.local_path }}" style="display: inline-block; padding: 10px 16px; background-color: #9a0000; color: white; text-decoration: none; font-size: 13px; min-width: 44px; text-align: center;">{% trans "View Book" %}</a>
                </div>
            </td>
        </tr>
        </table>
    </td>
</tr>
</table>
{% endfor %}
{% endfor %}
{% endif %}
{% endif %}

{# ===== CURRENTLY READING SECTION ===== #}
{% if currently_reading %}
<h2 style="color: #000000; margin-top: 32px; margin-bottom: 16px; font-size: 18px; border-bottom: 1px solid #e0e0e0; padding-bottom: 8px; font-weight: normal; letter-spacing: 0.02em;">{% trans "You're Currently Reading" %}</h2>

{% for item in currently_reading %}
<table style="width: 100%; margin-bottom: 20px; border-collapse: collapse;" cellpadding="0" cellspacing="0">
<tr>
    {% if item.book_cover %}
    <td style="width: 80px; vertical-align: top; padding-right: 20px;">
        <a href="{{ base_url }}{{ item.readthrough.book.local_path }}">
            <img src="{{ item.book_cover }}" alt="{{ item.readthrough.book.title }}" width="80" style="display: block; max-width: 80px; border: 1px solid #e0e0e0; box-shadow: 0 1px 3px rgba(0,0,0,0.12);">
        </a>
    </td>
    {% endif %}
    <td style="vertical-align: top;">
        <a href="{{ base_url }}{{ item.readthrough.book.local_path }}" style="color: #9a0000; text-decoration: none; font-size: 16px;">{{ item.readthrough.book.title }}</a>
        {% if item.readthrough.progress %}
        <p style="color: #3a3a3a; font-size: 14px; margin: 6px 0;">
            {% blocktrans with progress=item.readthrough.progress %}{{ progress }}% complete{% endblocktrans %}
        </p>
        {% elif item.readthrough.start_date %}
        <p style="color: #3a3a3a; font-size: 14px; margin: 6px 0;">
            {% blocktrans with date=item.readthrough.start_date|date:"M d" %}Started {{ date }}{% endblocktrans %}
        </p>
        {% endif %}
        <div style="margin-top: 10px;">
            <a href="{{ base_url }}{{ item.readthrough.book.local_path }}" style="display: inline-block; padding: 12px 20px; background-color: #1565c0; color: white; text-decoration: none; font-size: 14px; min-width: 44px; text-align: center;">{% trans "Update Progress" %}</a>
        </div>
    </td>
</tr>
</table>
{% endfor %}
{% endif %}

<p style="margin-top: 32px; text-align: center;">
    <a href="{{ base_url }}" style="display: inline-block; padding: 14px 40px; background-color: #9a0000; color: white; text-decoration: none; font-size: 16px; min-width: 44px;">{% trans "Visit your feed" %}</a>
</p>
{% endblock %}
