name: Run Python Tests
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      COMPOSE_FILE: "docker-compose.yml:docker-compose.ci.yml"
      COMPOSE_ENV_FILES: ".env.example:.env.ci"

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    - name: Build Docker images
      run: docker-compose build
    - name: Check if migrations are up-to-date
      run: docker-compose run web python manage.py makemigrations --check
    - name: Run pytest
      run: docker-compose run -e GITHUB_ACTIONS=true web pytest -n 3
